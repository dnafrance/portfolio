'use strict';angular.module("utility").directive("allSetModal",["cacheVersion","modal",function(c){return{templateUrl:"/templates/chat/all_set_modal.html?"+c}}]);angular.module("utility").filter("array",function(){return function(c){return _.values(c)}});angular.module("utility").directive("chatBox",["cacheVersion","chatDataStore","currentUser","$timeout",function(c,e,a,i){return{templateUrl:"/templates/chat/chat_box.html?"+c,scope:{recipientId:"@"},link:function(a,c){var h=_.throttle(function(){i(angular.noop)},1E3);a.recipient=e.getChannelObjectFromId(a.recipientId);a.focused=!0;a.mention={mentionState:!1};a.jabberIdToUserObjectMap={};a.newMessage={messageText:null};a.userList={show:!1};a.mentionText=null;var d=function(){var a=c.find(".chat-box-messages")[0];
a&&(a.scrollTop=a.scrollHeight)};_.defer(d);a.$watchCollection("recipient.conversation",function(){a.recipient.minimized||(e.markAllMessagesRead(a.recipient),_.defer(d))});c.find(".chat-box-input").keyup(function(b){13===b.which?a.sendMessage(a.recipient.id,a.newMessage.messageText):l()});a.$watch("recipient.minimized",function(){a.recipient.minimized||_.defer(d)});var b=/@\w*$/,l=_.throttle(function(){if(a.newMessage.messageText){var d=a.newMessage.messageText.match(b);if(d){0<d[0].length&&(a.mentionText=
d[0].slice(1));a.mention.mentionState=!0;return}}a.mention.mentionState=!1;a.mentionText=null},500);a.toggleMinimizeOnHeaderBarClick=function(){a.recipient.minimized&&a.toggleMinimize()};a.toggleMinimize=function(){a.recipient.minimized?(a.recipient.minimized=!1,e.unminimizeChannel(a.recipient)):a.recipient.minimized=!0};a.isCode=function(a){return"/code"===a.split(" ")[0]};var k=function(a,b){var n=a.split(b);return 1<n.length?n.slice(0,n.length-1).join(b):a};a.getNickNameFromUserId=function(a){if(a)return k(a,
"-")};a.getUserNameForDisplayNextToMessage=function(b){if(b){var d=k(b,"-");return a.isStaff(b)?d+" (staff)":d}};a.getUserFromJabberId=function(a){if(a)return k(a,"@")};a.shortenName=function(a){return a&&17<a.length?a.slice(0,14)+"...":a};a.getCodeSnippet=function(a){return a.slice(6)};a.placeUrlsInLinkTag=function(a){return a.replace(/(http[s]?:\/\/(www\.)?|www\.){1}([0-9A-Za-z-\.@:%_+~#=]+)+((\.[a-zA-Z]{2,3})+)(\/(.)*)?(\?(.)*)?/g,function(a){return"<a target='_blank' href=\""+a+'">'+a+"</a>"})};
a.mentionParticipant=function(d){d="@"+d+" ";a.newMessage.messageText||(a.newMessage.messageText="");if(null!==a.mentionText)a.newMessage.messageText=a.newMessage.messageText.replace(b,d),a.mention.mentionState=!1;else{var k=c.find(".chat-box-input")[0].selectionStart;a.newMessage.messageText=a.newMessage.messageText.slice(0,k)+d+a.newMessage.messageText.slice(k+1)}a.mentionText=null;a.userList.show=!1};a.isStaff=function(a){return a&&"staff.udacity.com"===_.last(a.split("@"))};a.sendMessage=function(b,
d){e.isRoom(b)&&e.sendRoomChat(b,d);a.newMessage.messageText=null;a.mention={mentionState:!1};h()};a.closeChat=function(){e.removeFromOpenChannels(e.getOpenChannels(),a.recipientId)}}}}]);angular.module("utility").service("chatDataStore",["chatServer","$timeout","currentUser","chatForm","dateTime","$log","notifications",function(c,e,a,i,g,j,h){var d=!1,b={roster:{users:{},rooms:{}},rooms:{},users:{},openChannels:{},courseCohortRooms:{},editedRoom:{currentlyEditing:{}},notifications:{hasUnreadMessages:!1},selectedCourse:{}},l=_.throttle(function(){e(angular.noop)},1E3),k=function(a){return function(){var b=Array.prototype.slice.call(arguments,0);a.apply(this,b);l()}},m=function(a){try{a()}catch(b){j.error(b)}},
f={init:function(){d||(d=!0,a.fetchEnrolledAndGraduatedNanodegreeKeys().then(function(a){var b=_.map(a,function(){return"public"}),b=_.object(a,b);f.setSelectedCourse(_.first(a));c.startChat(b);c.roomStream.subscribe(function(a){m(function(){f.addToRooms(a)})},function(a){j.error("error getting rooms",a)},function(){});c.directChatStream.subscribe(function(a){m(function(){f.addMessageToConversation(f.getUserInfo(a.from),a,!1)})},function(a){j.error(a)});c.roomChatStream.subscribe(function(a){m(function(){f.addMessageToConversation(f.getRoomInfo(a.roomId),
a,!0)})},function(a){j.error(a)});c.roomPresenceStream.subscribe(function(a){m(function(){f.updateRoomParticipants(f.getRoomFromPresence(a),a)})},function(a){j.error(a)});c.roomJoinedStream.subscribe(function(a){m(function(){var n=f.getRoomFromPresence(a);n?n.joinedTime=g.getCurrent():j.warn("room not yet added")})},function(a){j.error(a)},function(){j.warn("room joined stream over")});c.errorStream.subscribe(function(a){j.error(a)},function(a){j.error(a)})}))},getChatDataObject:function(){return b},
getRooms:function(){return b.rooms},getRoomFromPresence:function(a){return f.getRoomInfo(a.roomId)},getBookmarks:function(){return b.roster.rooms},getCourseCohortRooms:function(){return b.courseCohortRooms},getEditedRoom:function(){return b.editedRoom},getNotifications:function(){return b.notifications},getOpenChannels:function(){return b.openChannels},getSelectedCourse:function(){return b.selectedCourse},setRooms:function(a){k(function(){b.rooms=a})()},setCourseCohortRooms:function(a){k(function(){b.courseCohortRooms=
a})()},setBookmarks:function(a){k(function(){b.roster.rooms=a})()},setOpenChannels:function(a){k(function(){b.openChannels=a})},setNotifications:function(a){k(function(){b.notifications.hasUnreadMessages=a})()},setEditedRoom:function(a){k(function(){b.editedRoom.currentlyEditing=f.getRoomInfo(a)})()},setEmptyConversation:function(a){return _.extend(a,{conversation:[]})},setSelectedCourse:function(a){b.selectedCourse.courseKey=a},getChannelObjectFromId:function(a){return f.isRoom(a)?f.getRoomInfo(a):
f.getUserInfo(a)},isRoom:function(a){return c.isRoomId(a)},getRoomsByPurpose:function(a){return _.chain(f.getBookmarks()).map(function(a,b){return f.getRoomInfo(b)}).filter(function(b){return b&&b.purpose===a}).value()},getRoomsForCourseAndCohort:function(a,b){var d=f.getCourseCohortRooms();if(d[a]&&d[a][b])return d[a][b]},activateChannel:function(a){f.setOpenChannels(f.addToOpenChannels(a));a=f.getChannelObjectFromId(a);a.conversation||f.setEmptyConversation(a);f.markAllMessagesRead(a)},addToOpenChannels:function(a){b.openChannels[a]=
1;l()},joinRoom:function(a){c.joinRoom(a.id);f.saveBookmark(_.pick(a,"name","id"))},removeFromOpenChannels:function(a,b){delete a[b];l();return a},getConversation:function(a){return a.conversation},getConversationLength:function(a){return f.getConversation(a).length},removeBookmarkObject:function(a,b){delete a[b];return a},removeBookmark:function(a,b){f.removeBookmarkObject(a,b);c.fetchRoomBookmarks().subscribe(function(a){m(function(){c.uploadRoomBookmarks(_.filter(a,function(a){return a.id!==b}))})});
return a},getRoomInfo:function(a){if(a in f.getRooms())return f.getRooms()[a];var b=_.find(_.keys(f.getRooms()),function(b){if(a&&b)return b.toLowerCase()===a.toLowerCase()});return b?f.getRooms()[b]:null},getUserInfo:function(a){if(a in b.users)return b.users[a];var d=_.find(_.keys(b.users),function(b){return b.toLowerCase()===a.toLowerCase()});if(d)return b.users[d]},createMessageObject:function(a,b){return{message:b,lineNumber:f.getConversationLength(a),resolved:b.date>a.joinedTime?!1:!0}},addMentions:function(b,
d){var k=[];d.body.match("@"+a.get("jabber_id").split("@")[0])&&b.mentions&&(k=_.union(b.mentions,[f.createMessageObject(b,d)]));return _.extend(b,{mentions:k})},updateMessagesRead:function(a,b){if(a.joinedTime>b.date)return _.extend(a,{messagesRead:a.messagesRead?a.messagesRead+1:1});if(!(a.id in f.getOpenChannels())||a.minimized)f.setNotifications(!0),h.createNotification("chat",a.name+": New Message",b.body);return a},addToConversation:function(a,b){return _.extend(a,{conversation:_.union(a.conversation||
[],[b])})},sendRoomChat:function(a,b){c.sendRoomChat(a,b)},addMessageToConversation:function(a,b,d){k(function(){if(a)return d?f.updateMessagesRead(f.addMentions(f.addToConversation(a,b),b),b):f.updateMessagesRead(f.addToConversation(a,b),b);j.warn("received message from sender that is not recognized",b)})()},processUnavailablePresence:function(a,b){return f.removeParticipant(a,b.user)},removeParticipant:function(a,b){delete a.participants[b];a.numOccupants=_.size(a.participants);return a},createParticipant:function(a){return{id:a.user,
status:a.status,affiliation:a.affiliation,role:a.role,domain:a.domain}},processAvailablePresence:function(a,b){a.participants[b.user]=f.createParticipant(b);a.numOccupants=_.size(a.participants);var d=_.object([b.user],[f.createParticipant(b)]);_.defer(l);return _.extend(a,{participants:_.extend(a.participants||{},d),numOccupants:_.size(a.participants)})},createEmptyRoom:function(){return{category:"conference",cohort:"",conversation:[],course:"",description:"",id:"",name:"",numOccupants:0,purpose:"",
type:"text"}},createRoomFromSelfPresence:function(a){b.rooms[a.roomId]=f.createEmptyRoom();return b.rooms[a.roomId]},updateRoomParticipants:function(a,b){if(!a)if("owner"===b.affiliation&&b.isCurrentUser)a=f.createRoomFromSelfPresence(b);else{j.warn("id not found for given presence element",b);return}a.participants=a.participants||{};if("unavailable"===b.type)return f.processUnavailablePresence(a,b);if("unavailable"!==b.type)return f.processAvailablePresence(a,b)},leaveAllRooms:function(){_.forEach(f.getBookmarks(),
function(a){c.leaveRoom(a.id)})},uploadRoomBookmarks:function(a){c.uploadRoomBookmarks(a);return f.setBookmarks(a)},setRoomMinimized:function(a){return _.extend(a,{minimized:!0})},addRoomObject:function(a,b){("General Discussion"===b.name||"Projects"===b.name)&&f.joinRoom(b);return _.extend(a,_.object([b.id],[b]))},addRoomToCourseCohortRooms:function(a,b,d,k){var l=k.id;a[b]=a[b]||{};a[b][d]=a[b][d]||{};a[b][d][l]=k;return a},addToRooms:function(a){var a=f.setRoomMinimized(a),b=f.getRoomInfo(a.id);
b&&(a=_.extend(b,a),f.removeRoomObject(f.getRooms(),b.id));f.setRooms(f.addRoomObject(f.getRooms(),a));f.setCourseCohortRooms(f.addRoomToCourseCohortRooms(f.getCourseCohortRooms(),a.course,a.cohort,a));a.isBookmarked&&(c.joinRoom(a.id),f.setBookmarks(f.addBookmark(f.getBookmarks(),a.id)))},addBookmark:function(a,b){return _.extend(a,_.object([b],[1]))},saveBookmark:function(a){if(a.id){var b=f.addBookmark(f.getBookmarks(),a.id);c.fetchRoomBookmarks().subscribe(function(b){_.find(b,function(b){return b.id===
a.id})||c.uploadRoomBookmarks(_.union(b,[a]))});return b}},editRoom:function(a,b){c.editRoom(a,b).subscribe(function(a){m(function(){i.setRoomEditSucceeded();f.addToRooms(a)})},function(a){m(function(){j.warn("room was not edited");i.setRoomEditFailed();j.error(a)})})},createRoom:function(a,b,d,k){return c.createCustomRoom(a,b,d,k).subscribe(function(a){m(function(){f.saveBookmark(a);i.setRoomCreationSucceeded()})},function(a){j.warn("room was not created");i.setRoomCreationFailed();j.error(a)})},
leaveRoom:function(a){f.setBookmarks(f.removeBookmark(f.getBookmarks(),a.id));c.leaveRoom(a.id)},hasBookmark:function(a){return f.getBookmarks()[a]},pruneOpenChannels:function(a){if(a&&0<=a)for(;_.size(f.getOpenChannels())>a;){var b=_.first(_.keys(f.getOpenChannels()));f.setOpenChannels(f.removeFromOpenChannels(f.getOpenChannels(),b))}},markNonMentioningMessagesAsRead:function(a){return _.extend(a,{messagesRead:f.getConversationLength(a)})},markMentioningMessagesAsRead:function(a){return _.extend(a,
{mentions:_.map(a.mentions,function(a){return _.extend(a,{resolved:!0})})})},markAllMessagesRead:function(a){return a.mentions?f.markNonMentioningMessagesAsRead(f.markMentioningMessagesAsRead(a)):f.markNonMentioningMessagesAsRead(a)},unminimizeChannel:function(a){k(function(){_.extend(f.markAllMessagesRead(a),{minimized:!1});f.setNotifications(!1)})()},isInOpenChannels:function(a){return f.getOpenChannels()[a.id]},removeFromCourseCohortRooms:function(a,b,d,k){a[b]&&a[b][d]&&delete a[b][d][k];return a},
removeRoomObject:function(a,b){delete a[b];delete a[b.toLowerCase()];return a},deleteRoom:function(a){var b=f.getRoomInfo(a);c.deleteRoom(a,b.course,b.cohort);f.setBookmarks(f.removeBookmark(f.getBookmarks(),b.id));f.setCourseCohortRooms(f.removeFromCourseCohortRooms(f.getCourseCohortRooms(),b.course,b.cohort,a));f.setRooms(f.getRooms(),f.removeRoomObject(f.getRooms(),a));f.setOpenChannels(f.removeFromOpenChannels(f.getOpenChannels(),a))}};return f}]);angular.module("utility").service("chatForm",["$timeout",function(c){var e=function(){return{roomName:!1,description:!1,type:!1,errorMessages:[]}},a=function(){return{createSucceeded:null,editSucceeded:null}},i=_.throttle(function(){c(angular.noop)},1E3),g={invalidFields:{data:e()},submissionResults:{data:a()},isSubmissionSuccess:function(){return g.submissionResults.data.createSucceeded||g.submissionResults.data.editSucceeded},createSubmissionSucceeded:function(){return g.submissionResults.data.createSucceeded},
createSubmissionFailed:function(){return!1===g.submissionResults.data.createSucceeded},editSubmissionSucceeded:function(){return g.submissionResults.data.editSucceeded},editSubmissionFailed:function(){return!1===g.submissionResults.data.editSucceeded},hasNewSubmissionResults:function(){return null!==g.submissionResults.data.createSucceeded||null!==g.submissionResults.data.editSucceeded},clearSubmissionResults:function(){g.submissionResults.data=a()},resetInvalidFields:function(){g.invalidFields.data=
e()},setRoomCreationSucceeded:function(){g.clearSubmissionResults();g.submissionResults.data.createSucceeded=!0},setRoomCreationFailed:function(){g.clearSubmissionResults();g.submissionResults.data.createSucceeded=!1},setRoomEditSucceeded:function(){g.clearSubmissionResults();g.submissionResults.data.editSucceeded=!0},setRoomEditFailed:function(){g.clearSubmissionResults();g.submissionResults.data.editSucceeded=!1},checkForInvalidFields:function(a,c,d){var b=_.some([a,c,d],function(a){return!a});
g.invalidFields.data.errorMessages=[];var l=/^[\w\s\!\?,\.\-_\(\)]*$/;g.resetInvalidFields();if(!a||40<a.length)g.invalidFields.data.roomName=!0,a?a.match(l)?g.invalidFields.data.errorMessages.push("Group name must be less than 40 characters"):g.invalidFields.data.errorMessages.push("Invalid characters used in name. Please use alphanumeric symbols!"):g.invalidFields.data.errorMessages.push("Missing group name"),b=!0;c?c.match(l)||(g.invalidFields.data.errorMessages.push("Invalid characters used in description. Please use alphanumeric symbols!"),
b=!0):(g.invalidFields.data.description=!0,g.invalidFields.data.errorMessages.push("Missing group description"),b=!0);d||(g.invalidFields.data.type=!0,g.invalidFields.data.errorMessages.push("Missing group type"),b=!0);i();return b}};return g}]);angular.module("utility").directive("chatGroupListModal",["cacheVersion","chatDataStore","modal","chatForm","currentUser",function(c,e,a,i,g){return{templateUrl:"/templates/chat/chat_group_list_modal.html?"+c,link:function(a){a.selectedCourse=e.getSelectedCourse();a.selectedCohort="public";a.submissionResults=i.submissionResults;a.createSubmissionSucceeded=i.createSubmissionSucceeded;a.createSubmissionFailed=i.createSubmissionFailed;a.editSubmissionSucceeded=i.editSubmissionSucceeded;a.editSubmissionFailed=
i.editSubmissionFailed;a.submissionSuccess=i.isSubmissionSuccess;a.newSubmissionResults=i.hasNewSubmissionResults;a.getNumParticipants=function(a){return _.size(a.participants)};a.isOwner=function(a){var d=g.get("jabber_id");if(a.participants&&d in a.participants)return"owner"===a.participants[d].affiliation};a.joinAndBookmarkGroup=function(a){e.joinRoom(a)};a.deleteGroup=function(a){e.deleteRoom(a)};a.getGroupsOfType=function(a,d,b){return(d=e.getRoomsForCourseAndCohort(d,b))?_.filter(d,function(b){return b.purpose===
a}):null};a.isInBookmarks=function(a){return e.hasBookmark(a.id)};a.leaveGroupAndRemoveBookmark=function(a){e.leaveRoom(a)}}}}]);angular.module("utility").directive("chatPanel",["cacheVersion","chatDataStore","currentUser","fetchDiscourseLink","$window","notifications",function(c,e,a,i,g,j){return{templateUrl:"/templates/chat/chat_panel.html?"+c,link:function(c){c.purposes=["topic"];c.selectedCourse=e.getSelectedCourse();c.enrolledNanodegreeKeys=[];a.fetchEnrolledAndGraduatedNanodegreeKeys().then(function(a){c.enrolledNanodegreeKeys=a});c.userName=a.get("nickname")||a.get("first_name");c.getGroupsByPurpose=e.getRoomsByPurpose;
i().then(function(a){c.forumLink=a});c.notificationsMuted=!0;c.updateSelectedCourse=function(){e.setSelectedCourse(c.selectedCourse.courseKey)};c.isRoomInSelectedCourse=function(a){return a.course===c.selectedCourse.courseKey};c.toggleNotifications=function(){j.toggleMuteSettings("chat");c.notificationsMuted=!c.notificationsMuted};c.openForum=function(){c.forumLink&&g.open(c.forumLink)};c.openNdPortal=function(){g.open("/course/"+c.selectedCourse.courseKey)};c.numBookmarks=function(){return _.size(_.filter(e.getBookmarks(),
function(a,b){return e.getRoomInfo(b).course===c.selectedCourse.courseKey}))};c.getMaxNumberOfChatBoxes=function(){return 992<$(g).width()?2:1};var d=function(){_.size(e.getOpenChannels())>=c.getMaxNumberOfChatBoxes()&&e.pruneOpenChannels(c.getMaxNumberOfChatBoxes())},b=function(){d()};$(g).resize(b);c.$on("$destroy",function(){$(g).off("resize",b)});c.joinGroup=function(a){e.isInOpenChannels(a)||(e.hasBookmark(a.id)||e.saveBookmark({id:a.id,name:a.name}),e.activateChannel(a.id),d());e.unminimizeChannel(a)};
c.hasUnresolvedMentions=function(a){return!a.mentions?!1:_.some(a.mentions,function(a){return!a.resolved})}}}}]);angular.module("utility").service("chatServer",["chatServerHelper","strophe","currentUser","dateTime","$log",function(c,e,a,i,g){var j=null,h,d,b={startChat:function(l){b.getConnection()||(j=e.createXmppServerConnection());b.connectionSubject=new Rx.BehaviorSubject;var k=function(d){var d=d||1,c=2E3*d;b.getConnection().connect(a.get("jabber_id"),a.get("external_service_password"),function(a){var l=e.getConnectionStatus(a);b.connectionSubject.onNext(l);"disconnected"===e.getConnectionStatus(a)&&(g.warn("attempting to reconnect. Attempt number",
d),b.getConnection().disconnect(),g.warn("resetting connection"),b.getConnection().reset(),_.delay(k,c,d+1))})};k();b.connectionStream=b.connectionSubject.asObservable();b.connectionStream.subscribe(function(a){"connected"===a&&b.getConnection().send(e.createAvailablePresence())},function(a){console.error(a)},function(){});d=b.connectionStream.filter(function(a){return"connected"===a}).take(1);h=Rx.Observable.create(function(a){b.getConnection().addHandler(function(b){a.onNext(b);return!0},null,null,
null,null,null,null)}).publish();b.directChatStream=h.filter(c.filterDirectChatStanzas).map(c.mapDirectChatXmlToJson);b.roomChatStream=h.filter(c.filterRoomChatStanzas).map(c.mapRoomChatXmlToJson);b.roomPresenceStream=h.filter(c.filterRoomPresenceStanzas).map(c.mapRoomPresenceXmlToJson).publish();b.roomJoinedStream=b.roomPresenceStream.filter(c.filterRoomJoinedJson).map(function(a){return _.extend(a,{joinedTime:i.getCurrent()})});b.roomPresenceStream.connect();b.globalPresenceStream=h.filter(c.filterGlobalPresenceStanzas).map(c.mapGlobalPresenceXmlToJson);
b.roomJoinedFailedStream=h.filter(c.filterRoomJoinedFailedStanza).map(c.mapRoomJoinedFailedXmlToJson).subscribe(function(a){b.leaveRoom(a.id);_.delay(b.joinRoom,5E3,a.id)});b.errorStream=h.filter(c.filterErrorStanzas).map(c.mapErrorXmlToJson);b.roomStream=d.flatMap(function(){_.forEach(l,function(a,d){var k=c.createPathString(d,a);b.subscribeToPubsubNode(k)});return b.fetchRoomStream(l)});h.connect()},isRoomId:function(a){return e.isRoomId(a)},fetchRoomStream:function(a){return Rx.Observable.merge(b.fetchExistingRooms(a),
b.fetchNewRooms(a))},fetchNewRooms:function(a){return Rx.Observable.merge(_.map(a,function(a,d){return b.getNewRoomStreamAtPath(c.createPathString(d,a))})).map(function(a){return _.extend(a,{isBookmarked:!1})}).flatMap(function(a){return b.refreshRoomInfo(a)})},fetchExistingRooms:function(a){a=c.combineListOfObservables(_.map(a,function(a,d){return b.fetchRoomsAtPath(c.createPathString(d,a))})).map(c.joinListOfListsIntoOneList);a=c.combineObservableResults(a,b.fetchRoomBookmarks(),function(a,b){return{roomList:a,
bookmarkList:b}}).do(function(a){b.pruneBookmarks(a.roomList,a.bookmarkList)}).map(c.combineRoomAndBookmarkLists);return c.convertObsOfListIntoObsOfIndividualItems(a,b.refreshRoomInfo)},fetchRoomList:function(a){return Rx.Observable.zipArray.apply(null,_.map(a,function(a,d){return b.fetchRoomsAtPath(c.createPathString(d,a))})).take(1).map(function(a){return _.reduce(a,function(a,b){return a.concat(b)},[])})},pruneBookmarks:function(a,d){if(0<_.size(a)){var c=_.filter(d,function(b){return _.contains(_.map(a,
function(a){return a.id}),b.id)});b.uploadRoomBookmarks(c)}},refreshRoomInfo:function(a){return Rx.Observable.onErrorResumeNext(b.fetchRoomInfoFromRoomId(a.id),Rx.Observable.just()).take(1).map(function(b){return _.extend(a,b)})},subscribeToPubsubNode:function(a){return b.createIqResponseObservable(e.subscribeToPubsubNode(a)).subscribe(function(){},function(a){g.error("subscription failed",a)})},getConnection:function(){return j},pauseChat:function(){b.getConnection()&&b.getConnection().pause()},
endChat:function(){b.getConnection()&&(b.getConnection().send(e.createUnavailablePresenceElement()),b.getConnection().disconnect())},resumeChat:function(){b.getConnection()?b.getConnection().resume():b.startChat()},sendIndividualChat:function(a,d){if(b.getConnection()){var g=e.createDirectMessageElement(a,d);b.getConnection().send(g);return c.mapDirectChatXmlToJson(g)}return null},sendRoomChat:function(a,d){if(b.getConnection()){var g=e.createRoomChatMessageElement(a,d);b.getConnection().send(g);
return c.mapRoomChatXmlToJson(g)}return null},joinRoom:function(a){b.getConnection().send(e.createJoinRoomPresenceElement(a))},leaveRoom:function(a){b.getConnection().send(e.createLeaveRoomPresenceElement(a))},uploadRoomBookmarks:function(a){return b.createIqResponseObservable(e.createUploadBookmarksIqElement(a)).subscribe(function(){},function(a){console.error("bookmarks not saved",a)})},deleteBookmark:function(a,d){b.uploadRoomBookmarks(_.filter(a,function(a){return!_.isEqual(a,d)}))},deleteRoom:function(a,
d,i){d=c.createPathString(d,i);b.createIqResponseObservable(e.createDeleteRoomIqElement(a)).subscribe(function(){},function(a){g.error("deleting room failed",a)});b.createIqResponseObservable(e.createDeletePubsubItemElement(d,a)).subscribe(function(){},function(a){g.error("deleting pubsub room failed",a)})},fetchRoomBookmarks:function(){return Rx.Observable.onErrorResumeNext(b.createIqResponseObservable(e.createGetBookmarksIqElement()).doOnError(function(a){c.filterItemNotFoundStanza(a)&&b.uploadRoomBookmarks([])}).map(c.mapBookmarksXmlToJson),
Rx.Observable.just([])).take(1)},fetchRoomInfoFromRoomId:function(a){return b.createIqResponseObservable(e.createRoomInfoQuery(a)).map(c.mapRoomInfoQueryResponseXmlToJson)},fetchOpenRooms:function(){return Rx.Observable.create(function(a){b.getConnection().sendIQ(e.createOpenRoomsQuery(),function(b){a.onNext(b);a.onCompleted()},function(a){console.warn(a)})}).take(1).map(c.mapOpenRoomsXmlToJson)},createRoom:function(a,d){var g=h.filter(c.filterRoomCreatedStanzas(a)).take(1).flatMap(d);b.getConnection().send(e.createNewRoomPresenceElement(a));
return g},createRoomConfigurationStream:function(a){return b.createIqResponseObservable(e.createRequestConfigFormQueryElement(a))},createCustomRoom:function(a,d,g,f){var i=c.createPathString(d,g),d=e.getRoomJabberIdFromRoomName(a.roomName);return b.createRoom(d,b.configureRoom(a,d)).do(function(a){a&&b.saveRoomAtPath(i,f,a)}).flatMap(function(a){return b.refreshRoomInfo({id:a})})},editRoom:function(a,d){return b.configureRoom(a,d).flatMap(function(a){if(a)return b.refreshRoomInfo({id:a})})},createIqResponseObservable:function(a){return Rx.Observable.create(function(d){b.getConnection().sendIQ(a,
function(a){d.onNext(a);d.onCompleted()},function(a){d.onError(a);d.onCompleted()})}).take(1)},saveRoomAtPath:function(a,d,c){return b.createIqResponseObservable(e.createUploadRoomAccessIqElement(a,d,c)).subscribe(function(){},function(a){g.error("room not saved",a)})},configureRoom:function(a,d){return b.createRoomConfigurationStream(d).flatMap(function(g){return c.filterNoConfigPossibleStanza(g,d)?Rx.Observable.throw(Error("configurations not allowed")):Rx.Observable.onErrorResumeNext(b.createIqResponseObservable(e.createNewConfiguredRoomQueryElement(a,
d)),Rx.Observable.just()).take(1).map(c.getConfiguredRoomId(d))})},createConfiguredNode:function(a){return b.createIqResponseObservable(e.createConfiguredNodeElement(a)).subscribe(function(){b.subscribeToPubsubNode(a)},function(a){g.error("node creation failed",a)})},fetchRoomsAtPath:function(a){var d=e.createGetRoomAtNodesIqElement(a);return Rx.Observable.onErrorResumeNext(b.createIqResponseObservable(d).doOnError(function(d){c.filterItemNotFoundStanza(d)&&b.createConfiguredNode(a)}).map(c.mapPubSubRoomAtNodesResult),
Rx.Observable.just([])).take(1)},getNewRoomStreamAtPath:function(a){return h.filter(c.filterPubSubUpdateForNode(a)).filter(c.filterPubsubUpdateHasRoomNodeUpdate).map(c.mapPubSubRoomNodeUpdate)},createDefaultRoom:function(a){var d=e.getRoomJabberIdFromRoomName(a);return b.createRoom(d,function(){return Rx.Observable.fromCallback(b.getConnection().sendIQ)(e.createNewInstantRoomQueryElement(a)).map(function(a){return"result"===a.getAttribute("type")})})},revokeVoice:function(a,d,c){a=e.createRevokeVoiceQuery(a,
d,c);b.getConnection().sendIQ(a,function(){})},grantVoice:function(a,d,c){a=e.createGrantVoiceQuery(a,d,c);b.getConnection().sendIQ(a,function(){})},fetchRoster:function(){return b.createIqResponseObservable(e.createRosterQuery()).map(c.mapRosterXmlToJson)},getCurrentUserId:function(){return a.get("jabber_id")}};return b}]);angular.module("utility").service("chatServerHelper",["strophe",function(c){var e={combineListOfObservables:function(a){return Rx.Observable.zipArray.apply(null,a).take(1)},joinListOfListsIntoOneList:function(a){return _.reduce(a,function(a,c){return a.concat(c)},[])},combineObservableResults:function(a,c,g){return a.combineLatest(c,g).take(1)},convertObsOfListIntoObsOfIndividualItems:function(a,c){return a.flatMap(function(a){return Rx.Observable.merge(_.map(a,c))})},mapPubSubRoomItemToJson:function(a,
e){var g=c.getChild(a,"purpose");return{id:a.getAttribute("id"),purpose:c.getChild(g,"value").textContent,course:e.split("/")[0],cohort:e.split("/")[1]}},mapPubSubRoomAtNodesResult:function(a){if(a=c.getChild(a,"items")){var i=a.getAttribute("node");return _.chain(a.childNodes).filter(e.filterRoomNode).map(function(a){return e.mapPubSubRoomItemToJson(a,i)}).value()}console.warn("no items element in pubsub response")},mapPubSubRoomNodeUpdate:function(a){var i=c.getChild(a,"items").getAttribute("node"),
a=c.getChild(a,"item");return[e.mapPubSubRoomItemToJson(a,i)]},getConfiguredRoomId:function(a){return function(c){return"error"===c.getAttribute("type")?(console.warn("bad configurations passed in"),null):a}},createPathString:function(a,c){return"public"===a?"public":a+"/"+c},filterNoConfigPossibleStanza:function(a,i){return e.filterStanza(a,"iq",{from:i,type:"result"},["query"])&&0===c.getChild(a,"query").childElementCount},filterRoomNode:function(a){return e.filterStanza(a,"item",{},["entry"])&&
a.getAttribute("id")&&c.getChild(a,"entry")&&c.getChild(c.getChild(a,"entry"),"purpose")},filterPubsubUpdateHasRoomNodeUpdate:function(a){return(a=c.getChild(a,"item"))&&e.filterRoomNode(a)},filterRoomJoinedFailedStanza:function(a){return e.filterStanza(a,"presence",{type:"error"},["x","error"])&&e.filterStanza(c.getChild(a,"error"),"error",{type:"cancel"},["service-unavailable"])},filterNoBookmarkNodeStanza:function(a){return e.filterStanza(a,"iq",{type:"error"},["error","pubsub"])&&e.filterStanza(c.getChild(a,
"error"),"error",{code:"404",type:"cancel"},["item-not-found"])},filterPubsubStanza:function(a){return e.filterStanza(a,"iq",{type:"result",from:c.getPubsubDomain()},["pubsub"])&&e.filterStanza(c.getChild(a,"pubsub"),"pubsub",{xmlns:"http://jabber.org/protocol/pubsub"},["items"])},filterStanza:function(a,c,e,j){if(!a)return!1;var c=c?a.tagName.toLowerCase()===c:!0,h=0===_.filter(_.keys(e),function(d){return"string"===typeof a.getAttribute(d)?a.getAttribute(d).toLowerCase()!==e[d].toLowerCase():a.getAttribute(d)!==
e[d]}).length,j=0===_.filter(j,function(d){return 0===a.getElementsByTagName(d).length}).length;return c&&h&&j},filterDirectChatStanzas:function(a){return e.filterStanza(a,"message",{type:"chat"},["body"])},filterRoomChatStanzas:function(a){return e.filterStanza(a,"message",{type:"groupchat"},["body"])&&!e.filterStanza(c.getChild(a,"status"),"status",{code:"100"},[])},filterRoomPresenceStanzas:function(a){return e.filterStanza(a,"presence",{},["x"])&&e.filterStanza(c.getChild(a,"x"),"x",{xmlns:"http://jabber.org/protocol/muc#user"},
["item"])},filterItemNotFoundStanza:function(a){return e.filterStanza(a,"iq",{type:"error"},["error","pubsub"])&&e.filterStanza(c.getChild(a,"error"),"error",{type:"cancel"},["item-not-found"])},filterRoomJoinedJson:function(a){return"110"===a.status},filterGlobalPresenceStanzas:function(a){return e.filterStanza(a,{name:"presence",xmlns:null})},filterMaxUsersInRoomError:function(a,i){return e.filterStanza(a,"presence",{from:c.getJabberIdForUserInRoom(i),type:"error"},["x","error"])&&e.filterStanza(c.getChild(a,
"error"),"error",{by:i,type:"cancel"},["not-acceptable"])},filterPubSubUpdateForNode:function(a){return function(i){return e.filterStanza(i,"message",{from:c.getPubsubDomain()},["event"])&&e.filterStanza(c.getChild(i,"items"),"items",{node:a},["item"])&&!c.getChild(i,"delay")}},filterRoomCreatedStanzas:function(a){return function(i){var g=c.getChild(i,"x"),j=null;g&&(j=c.getChild(g,"item"));return g&&j&&e.filterStanza(i,"presence",{from:c.getJabberIdForUserInRoom(a)},["x"])&&e.filterStanza(g,"x",
{xmlns:"http://jabber.org/protocol/muc#user"},["item","status"])&&e.filterStanza(c.getChild(g,"status"),"status",{code:"110"},[])&&"owner"===j.getAttribute("affiliation")}},filterErrorStanzas:function(a){return e.filterStanza(a,"error",{},[])||e.filterStanza(a,null,{type:"error"},[])},mapDirectChatXmlToJson:function(a){return{from:c.getBareJid(a.getAttribute("from")),to:c.getBareJid(a.getAttribute("to")),body:c.getChildText(a,"body"),date:c.getDate(a)}},mapRoomChatXmlToJson:function(a){return{from:a.getAttribute("fullid")||
c.getUserNameFromRoomJid(a.getAttribute("from")),roomId:c.getBareJid(a.getAttribute("from")),to:c.getBareJid(a.getAttribute("to")),body:c.getChildText(a,"body"),date:c.getDate(a)}},mapRoomJoinedFailedXmlToJson:function(a){return{id:c.getBareJid(a.getAttribute("from")),code:c.getChild(a,"error").getAttribute("code")}},mapRoomPresenceXmlToJson:function(a){var e=null,g=null,j=null,h=null,d=null,b=c.getChild(a,"status");b&&(e=b.getAttribute("code"));if(b=c.getChild(a,"item"))g=b.getAttribute("affiliation"),
j=b.getAttribute("role"),h=c.getDomainFromJid(b.getAttribute("jid")),d=c.getBareJid(b.getAttribute("jid"));return{user:d,roomId:c.getBareJid(a.getAttribute("from")),type:a.getAttribute("type"),status:e,role:j,affiliation:g,domain:h,show:c.getChildText(a,"show"),isCurrentUser:"110"===c.getStatusCode(a)}},mapGlobalPresenceXmlToJson:function(a){return{user:a.getAttribute("from"),type:a.getAttribute("type")||"available",status:c.getChildText(a,"status"),show:c.getChildText(a,"show")}},mapErrorXmlToJson:function(a){return{message:(new XMLSerializer).serializeToString(a)}},
mapRosterXmlToJson:function(a){if(a=c.getChild(a,"query"))return a=a.getElementsByTagName("item"),_.map(a,function(a){return{id:a.getAttribute("jid"),name:a.getAttribute("name"),subscription:a.getAttribute("subscription"),group:c.getChildText(a,"group")}})},mapOpenRoomsXmlToJson:function(a){a=a.getElementsByTagName("item");return _.map(a,function(a){return{id:a.getAttribute("jid"),name:a.getAttribute("name")}})},combineRoomAndBookmarkLists:function(a){var c=a.bookmarkList;return _.map(a.roomList,
function(a){var e=!1;_.contains(_.map(c,function(a){return a.id}),a.id)&&(e=!0);return _.extend(a,{isBookmarked:e})})},mapBookmarksXmlToJson:function(a){if(e.filterNoBookmarkNodeStanza(a))return[];a=c.getChild(a,"storage");return _.chain(a.childNodes).filter(function(a){return"conference"===a.tagName.toLowerCase()}).map(function(a){return{name:a.getAttribute("name"),id:a.getAttribute("id")}}).value()},mapRoomInfoQueryResponseXmlToJson:function(a){var e=c.getChild(a,"identity"),g=_.chain(_.range(e.attributes.length)).map(function(a){return e.attributes[a].nodeName}).value(),
g=_.object(g,_.map(g,function(a){return e.getAttribute(a)})),a=c.getChild(a,"x"),j={};a&&a.childNodes&&(a=_.filter(a.childNodes,function(a){return"field"===a.tagName.toLowerCase()&&a.getAttribute("label")}),j=_.object(_.map(a,function(a){return c.getRoomInfoToAttributesMap()[a.getAttribute("var")]}),_.map(a,function(a){return c.getChildText(a,"value")})));j.numOccupants&&(j.numOccupants=parseInt(j.numOccupants));return _.extend(g,j)}};return e}]);angular.module("utility").directive("createChatGroupModal",["cacheVersion","chatDataStore","modal","chatForm","$timeout",function(c,e,a,i,g){return{templateUrl:"/templates/chat/create_chat_group_modal.html?"+c,link:function(c){c.groups=e.getRooms();var h=_.throttle(function(){g(angular.noop)},10),d=e.getSelectedCourse();i.resetInvalidFields();i.clearSubmissionResults();c.invalidFields=i.invalidFields;c.isInGroup=function(a){if(a)return e.hasBookmark(a.id)};c.joinGroupAndChangeModal=function(b){a.confirm();
c.openChatGroupListModal();e.joinRoom(b)};c.createRoom=function(b,g,k){i.checkForInvalidFields(b,g,k)||("topic"===k?(e.createRoom({roomName:b,description:g,membersOnly:0},d.courseKey,"public","topic"),c.groupType="topic"):(e.createRoom({roomName:b,description:g,membersOnly:0},d.courseKey,"public","study"),c.groupType="study"),a.confirm(),c.openChatGroupListModal(),h())}}}}]);angular.module("utility").directive("editGroupDescription",["cacheVersion","$timeout","$filter","chatDataStore",function(c,e,a,i){return{templateUrl:"/templates/chat/edit_group_description.html?"+c,link:function(c,j){var h=_.throttle(function(){e(angular.noop)},1E3),d=i.getSelectedCourse();c.suggestionsView={close:!1,groupNameInputHasFocus:!1};j.find("#name").focus(function(){c.suggestionsView.groupNameInputHasFocus=!0;c.suggestionsView.close=!1;h()});j.find("#name").blur(function(){c.suggestionsView.groupNameInputHasFocus=
!1;h()});c.showSuggestions=function(){c.suggestions=a("filter")(_.filter(_.values(c.groups),function(a){return a.course===d.courseKey}),c.newAttributes.groupName);return c.newAttributes.groupName&&c.suggestionsView.groupNameInputHasFocus&&!c.suggestionsView.close&&0<c.suggestions.length}}}}]);angular.module("utility").directive("editChatGroupModal",["cacheVersion","chatDataStore","modal","$timeout","chatForm",function(c,e,a,i,g){return{templateUrl:"/templates/chat/edit_chat_group_modal.html?"+c,link:function(c){c.invalidFields=g.invalidFields;c.editedGroup=e.getEditedRoom();var h=_.throttle(function(){i(angular.noop)},1E3);c.newAttributes={groupName:null,description:null};c.$watch("editedGroup.currentlyEditing",function(){if(!_.isEmpty(c.editedGroup.currentlyEditing)){var a=c.editedGroup.currentlyEditing;
c.newAttributes.groupName=a.name;c.newAttributes.description=a.description;c.groupId=a.id;h()}});c.editGroup=function(){var d={roomName:c.newAttributes.groupName,description:c.newAttributes.description};g.checkForInvalidFields(d.roomName,d.description,!0)||(e.editRoom(d,c.groupId),a.confirm(),c.openChatGroupListModal())}}}}]);angular.module("utility").directive("groupChat",["cacheVersion","$window","chatDataStore","modal","api","currentUser","chatForm","$timeout","showChat","notifications",function(c,e,a,i,g,j,h,d,b,l){return{templateUrl:"/templates/chat/group_chat.html?"+c,link:function(c){var e=_.throttle(function(){d(angular.noop)},10),f=!1;c.showGroupChat=!1;l.registerNotificationCreator("chat","muted");b.getGroupChatPromise().then(function(b){c.showGroupChat=b;c.showGroupChat&&!f&&(a.init(),j.checkIfFirstChatVisit().then(function(a){0===
a.data.tags.length?(j.setFirstChatVisit(),c.isFirstVisit=!0,c.inIntroFlow=!0,i.activate("introToChatModal").then(function(){},function(){c.inIntroFlow=!1})):(c.isFirstVisit=!1,c.inIntroFlow=!1);return!0}),f=!0)});c.showChat=!1;c.isStaff=j.isStaff;c.isFirstVisit=!0;c.inIntroFlow=!0;c.showChatWidget=function(){return!1===c.inIntroFlow||!1===c.isFirstVisit};c.groupType="topic";c.openChatGroupListModal=function(){i.activate("chatGroupListModal").then(function(){h.clearSubmissionResults()},function(){h.clearSubmissionResults();
c.inIntroFlow=!1})};c.showCreateGroupModal=function(){i.activate("createChatGroupModal").then(function(){},function(){c.inIntroFlow=!1})};c.showGetStartedModal=function(){i.activate("getStartedModal").then(function(){c.inIntroFlow=!1},function(){c.inIntroFlow=!1})};c.showEditGroupModal=function(b){a.setEditedRoom(b);i.activate("editChatGroupModal").then(function(){},function(){c.inIntroFlow=!1})};c.notifications=a.getNotifications();c.markRead=function(){c.notifications.hasUnreadMessages=!1};c.toggleChat=
function(){c.showChat=!c.showChat;c.markRead();e()};c.openChannelIds=a.getOpenChannels();c.getNumOpenChannels=function(){return _.size(c.openChannelIds)};c.activateChatGroupListModal=function(a){i.confirm();c.groupType=a;c.openChatGroupListModal()};c.activateAllSetModal=function(){i.activate("allSetModal").then(function(){c.inIntroFlow=!1},function(){c.inIntroFlow=!1})}}}}]).directive("chatWidget",["cacheVersion",function(c){return{templateUrl:"/templates/chat/chat_widget.html?"+c,link:function(){}}}]);angular.module("utility").directive("introToChatModal",["cacheVersion","modal",function(c){return{templateUrl:"/templates/chat/intro_to_chat_modal.html?"+c,link:function(){}}}]);angular.module("utility").service("strophe",["currentUser","dateTime","applicationEnvironment",function(c,e,a){var i=null,i=a.isInDevelopment()?"https://rumours-dev.udacity.com:5280":"https://rumours.udacity.com:5280",g=i+"/http-bind",j={};j[Strophe.Status.ERROR]="error";j[Strophe.Status.CONNECTING]="connecting";j[Strophe.Status.AUTHENTICATING]="connecting";j[Strophe.Status.CONNECTED]="connected";j[Strophe.Status.CONNFAIL]="connection failed";j[Strophe.Status.AUTHFAIL]="connection failed";j[Strophe.Status.DISCONNECTED]=
"disconnected";j[Strophe.Status.DISCONNECTING]="disconnecting";j[Strophe.Status.ATTACHED]="attached";var h={getJabberId:function(){return c.get("jabber_id")},getConnectionStatus:function(a){return j[a]},getBareJid:function(a){if(a)return Strophe.getBareJidFromJid(a)},getDomainFromJid:function(a){if(a)return Strophe.getDomainFromJid(a)},getNodeFromJid:function(a){if(a)return Strophe.getNodeFromJid(a)},getRoomDomain:function(){return"conference.udacity.com"},getRoomJid:function(a){return a+"@"+h.getRoomDomain()},
getUserNameFromRoomJid:function(a){return 0<a.split("/").length?a.split("/")[1]:null},createAvailablePresence:function(){return $pres().c("x",{xmlns:"http://jabber.org/protocol/muc"},"").tree()},getNickNameFromJabberId:function(a){if(a)return Strophe.getNodeFromJid(a)},getJabberIdForUserInRoom:function(a){return a+"/"+h.getNickName()},getPubsubDomain:function(){return"pubsub.udacity.com"},isRoomId:function(a){return Strophe.getDomainFromJid(a)===h.getRoomDomain()},getRoomInfoToAttributesMap:function(){return{"muc#roominfo_description":"description",
"muc#roominfo_subject":"subject","muc#roomconfig_changesubject":"allowChangeSubject","muc#roominfo_occupants":"numOccupants","muc#roominfo_lang":"language","muc#maxhistoryfetch":"maxHistory","muc#roominfo_pubsub":"pubsub"}},getRoomAttributesToMucAttributesMap:function(){return{roomName:"muc#roomconfig_roomname",description:"muc#roomconfig_roomdesc",language:"muc#roomconfig_lang",logging:"muc#roomconfig_enablelogging",allowChangeSubject:"muc#roomconfig_changesubject",allowInvites:"muc#roomconfig_allowinvites",
allowPrivateMessages:"muc#roomconfig_allowpm",maxUsers:"muc#roomconfig_maxusers",rolesForPresenceBroadcast:"muc#roomconfig_presencebroadcast",rolesThatCanGetMemberList:"muc#roomconfig_getmemberlist",publiclySearchable:"muc#roomconfig_publicroom",persistent:"muc#roomconfig_persistentroom",moderated:"muc#roomconfig_moderatedroom",membersOnly:"muc#roomconfig_membersonly",passwordRequired:"muc#roomconfig_passwordprotectedroom",password:"muc#roomconfig_roomsecret",whoCanDiscoverRealJabberIds:"muc#roomconfig_whois",
maxHistory:"muc#maxhistoryfetch",additionalRoomAdmins:"muc#roomconfig_roomadmins",additionalRoomOwners:"muc#roomconfig_roomowners"}},mapRoomAttributes:function(a){var b=h.getRoomAttributesToMucAttributesMap();return _.object(_.map(_.keys(a),function(a){return b[a]}),_.map(_.values(a),function(a){return null===a?"none":String(a)}))},createRosterQuery:function(){return $iq({from:h.getJabberId(),type:"get",id:"roster"}).c("query",{xmlns:"jabber:iq:roster"}).tree()},createNewRoomPresenceElement:function(a){a=
{from:h.getJabberId(),to:h.getJabberIdForUserInRoom(a)};return $pres(a).c("x",{xmlns:"http://jabber.org/protocol/muc"}).tree()},getRoomJabberIdFromRoomName:function(a){var a=a.replace(/[\~\!\*\(\)\'\s]/g,""),b=_.chain(_.range(0,5)).map(function(){return String.fromCharCode(65+Math.floor(26*Math.random()))}).reduce(function(a,b){return a.concat(b)},"").value();return encodeURI(a)+"-"+Date.now()+b+"@"+h.getRoomDomain()},createNewInstantRoomQueryElement:function(a){var a={from:h.getJabberId(),to:h.getJabberIdForUserInRoom(h.getRoomJabberIdFromRoomName(a)),
type:"set"},b=$q({xmlns:"http://jabber.org/protocol/muc#owner"}),c=$build("x",{xmlns:"jabber:x:data",type:"submit"});b.appendChild(c);return $iq(a).c(b).tree()},createRequestConfigFormQueryElement:function(a){return $iq({from:h.getJabberId(),to:a,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).tree()},createGetBookmarksIqElement:function(){return $iq({from:h.getJabberId(),type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("items",{node:"storage:bookmarks"}).tree()},
createDeleteRoomIqElement:function(a){return $iq({from:h.getJabberId(),to:a,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).c("destroy").tree()},createDeletePubsubItemElement:function(a,b){return $iq({type:"set",from:h.getJabberId(),to:h.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("retract",{node:a}).c("item",{id:b}).tree()},createUploadBookmarksIqElement:function(a){return h.createUploadDataIqElement("storage:bookmarks",h.createRoomBookmarkItems(a))},
createUploadRoomAccessItem:function(a,b){return $build("item",{id:b}).c("entry",{xmlns:"http://www.w3.org/2005/Atom"}).c("purpose",{}).c("value",{},a).tree()},createConfiguredNodeElement:function(a){return $iq({type:"set",from:h.getJabberId(),to:h.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("create",{node:a}).up().c("configure").c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value",{},"http://jabber.org/protocol/pubsub#node_config").up().c("field",
{"var":"pubsub#access_model"}).c("value",{},"open").up().c("field",{"var":"pubsub#publish_model"}).c("value",{},"open").tree()},createUploadRoomAccessIqElement:function(a,b,c){return h.createUploadDataIqElement(a,h.createUploadRoomAccessItem(b,c),h.getPubsubDomain())},createSubscribeToPubsubNodeElement:function(a){return $iq({type:"set",from:h.getJabberId(),to:h.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:h.getJabberId()}).tree()},createRoomInfoQuery:function(a){return $build("iq",
{from:h.getJabberId(),to:a,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#info"}).tree()},createGetRoomAtNodesIqElement:function(a){return $iq({type:"get",from:h.getJabberId(),to:h.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("items",{node:a}).tree()},createUploadDataIqElement:function(a,b,c){var e={from:h.getJabberId(),type:"set"};c&&(e.to=c);var a=$iq(e).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("publish",{node:a}).cnode(b).up().up(),
g=$build("x",{xmlns:"jabber:x:data",type:"submit"}),b=[$build("field",{"var":"FORM_TYPE",type:"hidden"}).c("value",{},"http://jabber.org/protocol/pubsub#publish-options").up(),$build("field",{"var":"pubsub#persist_items"}).c("value",{},"true").up()];_.forEach(b,function(a){g.cnode(a.tree()).up()});b=$build("publish-options",{}).cnode(g.tree()).up();a.cnode(b.tree());return a.tree()},createRoomBookmarkItems:function(a){var a=_.map(a,function(a){return $build("conference",{name:a.name,autojoin:"true",
jid:a.id,id:a.id}).tree()}),b=$build("storage",{xmlns:"storage:bookmarks"});_.forEach(a,function(a){b.cnode(a).up()});b.c("nick",{},h.getNickName());return $build("item",{id:"current"}).cnode(b.tree()).tree()},createNewConfiguredRoomQueryElement:function(a,b){var c=_.map(h.mapRoomAttributes(a),function(a,b){return $build("field",{"var":b}).c("value",{},a).tree()}),e=$build("x",{xmlns:"jabber:x:data",type:"submit"});e.cnode($build("field",{"var":"FORM_TYPE"}).c("value",{},"http://jabber.org/protocol/muc#roomconfig").tree()).up();
_.forEach(c,function(a){a&&e.cnode(a).up()});c=$build("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(e.tree()).tree();return $build("iq",{from:h.getJabberId(),to:b,type:"set"}).cnode(c).tree()},createUnavailablePresenceElement:function(){return $pres({from:h.getJabberId(),type:"unavailable"}).tree()},createJoinRoomPresenceElement:function(a){var a={from:h.getJabberId(),to:h.getJabberIdForUserInRoom(a)},b=$build("x",{xmlns:"http://jabber.org/protocol/muc"}).tree();return $pres(a).cnode(b).tree()},
createLeaveRoomPresenceElement:function(a){a={from:h.getJabberId(),to:h.getJabberIdForUserInRoom(a),type:"unavailable"};return $pres(a).tree()},createRoomChatMessageElement:function(a,b){return $msg({to:a,from:h.getJabberId(),type:"groupchat",fullid:h.getJabberId()}).c("body",{},b).tree()},createDirectMessageElement:function(a,b){return $msg({to:a,from:h.getJabberId(),type:"chat"}).c("body",{},b).tree()},createOpenRoomsQuery:function(){return $iq({from:h.getJabberId(),to:"conference.udacity.com",
type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}).tree()},getNickName:function(){if(h.getJabberId())return Strophe.getNodeFromJid(h.getJabberId())},getUserNameInRoom:function(a){if(a)return Strophe.getResourceFromJid(a)},getRoomName:function(a){if(a)return Strophe.getNodeFromJid(a)},createXmppServerConnection:function(){return new Strophe.Connection(g)},getServerBaseUrl:function(){return i},getStatusCode:function(a){return(a=h.getChild(a,"x"))&&h.getChild(a,"status")?h.getChild(a,
"status").getAttribute("code"):null},subscribeToPubsubNode:function(a){return $iq({type:"set",to:h.getPubsubDomain(),from:h.getJabberId()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:h.getJabberId()}).tree()},getChild:function(a,b){if(a.hasChildNodes()){var c=a.getElementsByTagName(b);return 0<c.length?c[0]:_.find(_.map(a.childNodes,function(a){return h.getChild(a,b)}),function(a){return null!==a})}return null},getChildText:function(a,b){var c=h.getChild(a,b);
return c?Strophe.getText(c):null},getDate:function(a){var b=e.getCurrent(),a=a.getElementsByTagName("delay");0<a.length&&"urn:xmpp:delay"===a[0].getAttribute("xmlns")&&(b=a[0].getAttribute("stamp"),b=new Date(b));return b}};return h}]);
